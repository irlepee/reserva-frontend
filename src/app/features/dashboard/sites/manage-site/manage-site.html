
<div class="main-container">
  
  <div class="top-section">
    <div class="top-left">
      <button class="back-button" (click)="goBack()">
        <i class="bi bi-arrow-left"></i>
      </button>
      <div>
        <h2>Administrar Sitio</h2>
        <p class="site-name">{{ siteName }}</p>
      </div>
    </div>
  </div>

  <div *ngIf="loading" class="loading-state">
    <i class="bi bi-hourglass-split"></i>
    <p>Cargando información...</p>
  </div>

  <div *ngIf="!loading" class="manage-content">
    
    <!-- Tarjetas de resumen -->
    <div class="summary-cards">
      <div class="summary-card">
        <div class="card-icon blue">
          <i class="bi bi-calendar-check"></i>
        </div>
        <div class="card-info">
          <span class="card-value">{{ stats.totalReservas }}</span>
          <span class="card-label">Total Reservas</span>
        </div>
      </div>
      
      <div class="summary-card">
        <div class="card-icon green">
          <i class="bi bi-calendar-week"></i>
        </div>
        <div class="card-info">
          <span class="card-value">{{ stats.reservasUltimaSemana }}</span>
          <span class="card-label">Última Semana</span>
        </div>
      </div>
      
      <div class="summary-card">
        <div class="card-icon purple">
          <i class="bi bi-calendar-month"></i>
        </div>
        <div class="card-info">
          <span class="card-value">{{ stats.reservasUltimoMes }}</span>
          <span class="card-label">Último Mes</span>
        </div>
      </div>
      
      <div class="summary-card">
        <div class="card-icon orange">
          <i class="bi bi-percent"></i>
        </div>
        <div class="card-info">
          <span class="card-value">{{ stats.tasaOcupacion }}%</span>
          <span class="card-label">Tasa de Ocupación</span>
        </div>
      </div>
    </div>

    <!-- Gráficas principales - Full Width -->
    <div class="charts-section">
      
      <!-- Reservas por día de la semana -->
      <div class="chart-card full-width">
        <h3 class="chart-title">
          <i class="bi bi-bar-chart-fill"></i>
          Reservas por Día de la Semana
        </h3>
        <p class="chart-subtitle">Últimas 4 semanas</p>
        <div class="bar-chart">
          <div class="bar-item" *ngFor="let dia of stats.reservasPorDia">
            <div class="bar-container">
              <div class="bar" 
                   [style.height.%]="(dia.cantidad / getMaxReservasDia()) * 100"
                   [attr.data-value]="dia.cantidad">
              </div>
            </div>
            <span class="bar-label">{{ dia.dia }}</span>
          </div>
        </div>
      </div>

      <!-- Top recursos -->
      <div class="chart-card">
        <h3 class="chart-title">
          <i class="bi bi-trophy-fill"></i>
          Recursos Más Reservados
        </h3>
        <p class="chart-subtitle">Ranking por cantidad de reservas</p>
        <div class="ranking-list" *ngIf="stats.topRecursos.length > 0">
          <div class="ranking-item" *ngFor="let recurso of stats.topRecursos; let i = index">
            <div class="ranking-position" [ngClass]="{'gold': i === 0, 'silver': i === 1, 'bronze': i === 2}">
              {{ i + 1 }}
            </div>
            <div class="ranking-info">
              <span class="ranking-name">{{ recurso.nombre }}</span>
              <span class="ranking-count">{{ recurso.reservas }} reservas</span>
            </div>
            <div class="ranking-bar">
              <div class="ranking-fill" [style.width.%]="recurso.porcentaje"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Horas más populares -->
      <div class="chart-card">
        <h3 class="chart-title">
          <i class="bi bi-clock-fill"></i>
          Horas Más Populares
        </h3>
        <p class="chart-subtitle">Momentos con más reservas</p>
        <div class="bar-chart horizontal">
          <div class="bar-item" *ngFor="let hora of stats.horasPopulares">
            <span class="bar-label">{{ hora.hora }}</span>
            <div class="bar-container">
              <div class="bar" 
                   [style.width.%]="(hora.cantidad / getMaxHorasPopulares()) * 100"
                   [attr.data-value]="hora.cantidad">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tipos de reserva -->
      <div class="chart-card">
        <h3 class="chart-title">
          <i class="bi bi-pie-chart-fill"></i>
          Tipos de Reserva
        </h3>
        <p class="chart-subtitle">Individuales vs Grupales</p>
        <div class="reservation-types">
          <div class="type-item">
            <div class="type-icon individual">
              <i class="bi bi-person"></i>
            </div>
            <div class="type-info">
              <span class="type-value">{{ stats.tiposReserva.individuales }}</span>
              <span class="type-label">Individuales</span>
            </div>
          </div>
          <div class="type-item">
            <div class="type-icon group">
              <i class="bi bi-people"></i>
            </div>
            <div class="type-info">
              <span class="type-value">{{ stats.tiposReserva.grupales }}</span>
              <span class="type-label">Grupales</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Panel de Reservas -->
    <div class="reservas-section">
      <div class="reservas-header">
        <div>
          <h3 class="section-title">
            <i class="bi bi-calendar-event"></i>
            Reservas del Sitio
          </h3>
          <p class="reservas-subtitle">{{ getTotalReservasForDate() }} reservas para {{ formatDate(selectedDate) }}</p>
        </div>
        
        <div class="date-picker-container">
          <label for="date-picker">Seleccionar fecha:</label>
          <input 
            type="date" 
            id="date-picker" 
            [(ngModel)]="selectedDate" 
            (change)="onDateChange()"
            class="date-picker"
          >
        </div>
      </div>

      <div *ngIf="loadingReservas" class="loading-state">
        <i class="bi bi-hourglass-split"></i>
        <p>Cargando reservas...</p>
      </div>

      <div *ngIf="!loadingReservas && getTotalReservasForDate() === 0" class="no-reservas">
        <i class="bi bi-inbox"></i>
        <p>No hay reservas para esta fecha</p>
      </div>

      <div *ngIf="loadingCategories" class="loading-categories">
        <i class="bi bi-hourglass-split"></i>
        <p>Cargando categorías de recursos...</p>
      </div>

      <div *ngIf="!loadingReservas && getTotalReservasForDate() > 0" class="categories-list">
        <ng-container *ngFor="let categoryName of resourcesByCategory | keyvalue">
          <div class="category-group" 
               [class.has-reservas]="getReservasForCategory(categoryName.key) > 0"
               *ngIf="hasCategoryReservas(categoryName.key)">
          
            <div class="category-header" (click)="toggleCategory(categoryName.key)">
              <div class="category-info">
                <i class="bi" [ngClass]="expandedCategories[categoryName.key] ? 'bi-chevron-down' : 'bi-chevron-right'"></i>
                <h4 class="category-name">{{ categoryName.key }}</h4>
                <span class="category-count">{{ getReservasForCategory(categoryName.key) }}</span>
              </div>
            </div>

          <div class="category-resources" *ngIf="expandedCategories[categoryName.key]">
            
            <ng-container *ngFor="let resource of categoryName.value">
              <div class="resource-group" 
                   [class.has-reservas]="(reservasByResource[resource.id] || []).length > 0"
                   *ngIf="(reservasByResource[resource.id] || []).length > 0">
              
                <div class="resource-header" (click)="toggleResource(resource.id)">
                  <div class="resource-info">
                    <i class="bi" [ngClass]="expandedResources[resource.id] ? 'bi-chevron-down' : 'bi-chevron-right'"></i>
                    <h5 class="resource-name">{{ resource.name }}</h5>
                    <span class="resource-count">
                      {{ (reservasByResource[resource.id] || []).length }}
                    </span>
                  </div>
                </div>

                <div class="resource-reservas" *ngIf="expandedResources[resource.id]">
                  <div class="reserva-card" *ngFor="let reserva of reservasByResource[resource.id]; let i = index">
                    <div class="reserva-header">
                      <div class="reserva-title">
                        <h6>{{ reserva.resource_name }}</h6>
                        <span class="reserva-group" *ngIf="reserva.group_name">
                          <i class="bi bi-people"></i> {{ reserva.group_name }}
                        </span>
                        <span class="reserva-personal" *ngIf="!reserva.group_name">
                          <i class="bi bi-person"></i> Reserva Personal
                        </span>
                      </div>
                      <span class="status-badge" [class]="reserva.status.toLowerCase()">
                        {{ reserva.status === 'In Progress' ? 'En Progreso' : reserva.status === 'Active' ? 'Activa' : 'Cancelada' }}
                      </span>
                      <!-- Debug: {{ reserva.status }} -->
                    </div>

                    <div class="reserva-details">
                      <div class="detail-item">
                        <i class="bi bi-clock"></i>
                        <span>{{ formatTime(reserva.start_date) }} - {{ formatTime(reserva.end_date) }}</span>
                      </div>
                    </div>

                    <div class="reserva-actions" *ngIf="reserva.status === 'In Progress' || reserva.status === 'Active'">
                      <button class="btn-cancel" (click)="openCancelModal(reserva.id, resource.id)">
                        <i class="bi bi-x-circle"></i> Cancelar
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </ng-container>
            </div>
          </div>
        </ng-container>
      </div>
    </div>
  </div>

</div>

<!-- Modal de confirmación para cancelar reserva -->
<div class="modal-overlay" *ngIf="showCancelModal" (click)="closeCancelModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Confirmar Cancelación</h3>
      <button class="modal-close" (click)="closeCancelModal()">
        <i class="bi bi-x"></i>
      </button>
    </div>
    <div class="modal-body">
      <p>¿Estás seguro de que deseas cancelar esta reserva?</p>
      <p class="modal-warning">Esta acción no se puede deshacer.</p>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" (click)="closeCancelModal()">Cancelar</button>
      <button class="btn-danger" (click)="confirmCancelReserva()">Confirmar Cancelación</button>
    </div>
  </div>
</div>
