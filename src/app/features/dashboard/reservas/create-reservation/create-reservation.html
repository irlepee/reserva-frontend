<div class="reservation-modal">
  <!-- PASO 1: Búsqueda de sitio -->
  <div class="step-container" *ngIf="step === 'search'">
    <div class="search-header">
      <h2>Busca un lugar para reservar</h2>
      <p>Ingresa el nombre del sitio que deseas reservar</p>
    </div>

    <div class="search-box">
      <i class="bi bi-search"></i>
      <input
        type="text"
        [(ngModel)]="searchTerm"
        (input)="searchSites()"
        placeholder="Busca un sitio..."
        class="search-input"
      />
      <span *ngIf="isSearching" class="search-loader">
        <i class="bi bi-arrow-repeat"></i>
      </span>
    </div>

    <div class="sites-list" *ngIf="searchedSites.length > 0">
      <div class="site-item" *ngFor="let site of searchedSites" (click)="selectSite(site)">
        <div class="site-image" *ngIf="getImageUrl(site.images)">
          <img [src]="getImageUrl(site.images)" alt="{{ site.name }}" />
        </div>
        <div class="site-info">
          <h3>{{ site.name }}</h3>
          <p>{{ site.description || 'Sin descripción' }}</p>
          <span class="site-location" *ngIf="site.location || site.municipio">
            <i class="bi bi-geo-alt"></i> {{ site.location || site.municipio }}
          </span>
        </div>
        <i class="bi bi-chevron-right"></i>
      </div>
    </div>

    <div class="no-results" *ngIf="searchTerm && searchedSites.length === 0 && !isSearching">
      <p>No se encontraron sitios</p>
    </div>
  </div>

  <!-- PASO 2: Selección de recurso -->
  <div class="step-container" *ngIf="step === 'resources'">
    <div class="step-header">
      <button class="btn-back" (click)="goBack()">← Atrás</button>
      <h2>Selecciona un recurso</h2>
    </div>

    <div class="site-details" *ngIf="selectedSite">
      <!-- Galería de imágenes -->
      <div class="site-gallery" *ngIf="getAllImageUrls(selectedSite.images).length > 0">
        <div class="gallery-scroll">
          <img 
            *ngFor="let imgUrl of getAllImageUrls(selectedSite.images)" 
            [src]="imgUrl" 
            alt="{{ selectedSite.name }}"
            class="gallery-image"
          />
        </div>
      </div>

      <!-- Información del sitio -->
      <div class="site-info-card">
        <h3>{{ selectedSite.name }}</h3>
        <p class="site-description">{{ selectedSite.description || 'Sin descripción' }}</p>
        
        <div class="site-meta">
          <span class="meta-item" *ngIf="selectedSite.location || selectedSite.municipio">
            <i class="bi bi-geo-alt"></i> {{ selectedSite.location || selectedSite.municipio }}
          </span>
          <span class="meta-item">
            <i class="bi bi-box"></i> {{ siteResources.length }} recursos disponibles
          </span>
        </div>
      </div>
    </div>

    <div class="resources-container">
      <h4>Recursos disponibles</h4>
      
      <!-- Recursos organizados por categoría -->
      <div class="category-section" *ngFor="let category of categories">
        <div class="category-header">
          <i class="bi bi-tag"></i>
          <span>{{ category }}</span>
          <span class="category-count">({{ getResourcesByCategory(category).length }})</span>
        </div>
        
        <div class="resources-grid">
          <div
            class="resource-card"
            *ngFor="let resource of getResourcesByCategory(category)"
            (click)="selectResource(resource)"
          >
            <div class="resource-header">
              <h5>{{ resource.name }}</h5>
              <span class="resource-status" [class.available]="resource.status === 'Available'">
                {{ resource.status === 'Available' ? 'Disponible' : resource.status }}
              </span>
            </div>
            <p class="resource-capacity" *ngIf="resource.capacity">
              <i class="bi bi-people"></i> Capacidad: {{ resource.capacity }}
            </p>
          </div>
        </div>
      </div>

      <!-- Si no hay categorías pero sí recursos -->
      <div class="resources-grid" *ngIf="categories.length === 0 && siteResources.length > 0">
        <div
          class="resource-card"
          *ngFor="let resource of siteResources"
          (click)="selectResource(resource)"
        >
          <div class="resource-header">
            <h5>{{ resource.name }}</h5>
            <span class="resource-status" [class.available]="resource.status === 'Available'">
              {{ resource.status === 'Available' ? 'Disponible' : resource.status }}
            </span>
          </div>
          <p class="resource-capacity" *ngIf="resource.capacity">
            <i class="bi bi-people"></i> Capacidad: {{ resource.capacity }}
          </p>
        </div>
      </div>

      <!-- Sin recursos -->
      <div class="no-resources" *ngIf="siteResources.length === 0">
        <i class="bi bi-inbox"></i>
        <p>Este sitio no tiene recursos disponibles</p>
      </div>
    </div>
  </div>

  <!-- PASO 3: Calendario y horario -->
  <div class="step-container" *ngIf="step === 'datetime'">
    <div class="step-header">
      <button class="btn-back" (click)="goBack()">← Atrás</button>
      <h2>Selecciona fecha y horario</h2>
    </div>

    <div class="resource-selected">
      <span class="resource-name">{{ selectedResource.name }}</span>
    </div>

    <div class="datetime-container">
      <!-- Calendario -->
      <div class="calendar-section">
        <div class="calendar-header-controls">
          <button class="btn-month" (click)="previousMonth()" title="Mes anterior">
            <i class="bi bi-chevron-left"></i>
          </button>
          <h4>{{ getMonthYear() }}</h4>
          <button class="btn-month" (click)="nextMonth()" title="Mes siguiente">
            <i class="bi bi-chevron-right"></i>
          </button>
        </div>
        
        <div class="calendar">
          <div class="calendar-header">
            <div>L</div>
            <div>M</div>
            <div>M</div>
            <div>J</div>
            <div>V</div>
            <div>S</div>
            <div>D</div>
          </div>
          <div class="calendar-days">
            <div
              class="day"
              *ngFor="let day of getCalendarDays()"
              [class.empty]="!day"
              [class.selected]="isDateSelected(day)"
              [class.disabled]="isDateDisabled(day)"
              (click)="selectDate(day)"
            >
              {{ day }}
            </div>
          </div>
        </div>

        <div *ngIf="selectedDate" class="selected-date-display">
          <i class="bi bi-check-circle-fill"></i>
          Fecha seleccionada: {{ selectedDate | date: 'dd/MM/yyyy' }}
        </div>
      </div>

      <!-- Horarios -->
      <div class="time-section">
        <h4>Horario de reserva</h4>
        <div class="time-inputs">
          <div class="time-group">
            <label>Desde</label>
            <select [(ngModel)]="startTime" class="time-input">
              <option value="">Selecciona una hora</option>
              <option *ngFor="let hour of getAvailableHours()" [value]="hour">
                {{ hour }}:00
              </option>
            </select>
            <small *ngIf="selectedDate" class="time-hint">
              Desde la hora actual
            </small>
          </div>
          <div class="time-group">
            <label>Hasta</label>
            <select [(ngModel)]="endTime" class="time-input">
              <option value="">Selecciona una hora</option>
              <option *ngFor="let hour of getEndHours()" [value]="hour">
                {{ hour }}:00
              </option>
            </select>
            <small class="time-hint">
              Mínimo 1 hora de duración
            </small>
          </div>
        </div>

        <div *ngIf="startTime && endTime" class="time-summary">
          <div class="time-summary-item">
            <span>Duración:</span>
            <strong>{{ calculateDuration() | number: '1.0-0' }} horas</strong>
          </div>
        </div>
      </div>
    </div>

    <button class="btn-next" (click)="goToSummary()" [disabled]="!selectedDate">
      Continuar
    </button>
  </div>

  <!-- PASO 4: Resumen -->
  <div class="step-container" *ngIf="step === 'summary'">
    <div class="step-header">
      <button class="btn-back" (click)="goBack()">← Atrás</button>
      <h2>Resumen de la reserva</h2>
    </div>

    <div class="summary-container">
      <!-- Header con icono -->
      <div class="summary-header">
        <i class="bi bi-calendar-check"></i>
        <h3>¡Tu reserva está lista!</h3>
        <p>Revisa los detalles antes de confirmar</p>
      </div>

      <!-- Detalles de la reserva -->
      <div class="summary-card">
        <div class="summary-row">
          <div class="icon site">
            <i class="bi bi-building"></i>
          </div>
          <div class="info">
            <span class="label">Sitio</span>
            <span class="value">{{ selectedSite.name }}</span>
          </div>
        </div>

        <div class="summary-row">
          <div class="icon resource">
            <i class="bi bi-box"></i>
          </div>
          <div class="info">
            <span class="label">Recurso</span>
            <span class="value">{{ selectedResource.name }}</span>
            <span class="sub-value" *ngIf="selectedResource.capacity">
              <i class="bi bi-people"></i> Capacidad: {{ selectedResource.capacity }} personas
            </span>
          </div>
        </div>

        <div class="summary-row">
          <div class="icon date">
            <i class="bi bi-calendar3"></i>
          </div>
          <div class="info">
            <span class="label">Fecha</span>
            <span class="value">{{ selectedDate | date: 'EEEE, d MMMM yyyy' }}</span>
          </div>
        </div>

        <div class="summary-row">
          <div class="icon time">
            <i class="bi bi-clock"></i>
          </div>
          <div class="info">
            <span class="label">Horario</span>
            <span class="value">{{ startTime }}:00 - {{ endTime }}:00</span>
          </div>
        </div>
      </div>

      <!-- Duración -->
      <div class="summary-duration">
        <i class="bi bi-hourglass-split"></i>
        <span>Duración total: {{ calculateDuration() }} hora(s)</span>
      </div>

      <!-- Botón confirmar -->
      <button class="btn-reserve" (click)="createReservation()">
        <i class="bi bi-check-circle"></i>
        Confirmar reserva
      </button>
    </div>
  </div>
</div>
